<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>Carrito de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/carrito.css">
</head>
<body>
<div class="container my-4">
    <div class="cart-container p-3 p-md-4">
        <h1 class="h3 mb-4">Carrito de Compras</h1>

        <!-- Sección de Envío, Entrega y Pago -->
        <div class="row mb-3">
            <div class="col-3 section-title">ENVÍO</div>
            <div class="col-9 info-text"><button class="btn btn-outline-primary" id="btnVerDirecciones">Direcciones de envío</button></div>
        </div>

        <div class="row mb-3">
            <div class="col-3 section-title">ENTREGA</div>
            <div class="col-9">
                <span class="delivery-option" th:text="${envio == 0 ? 'Gratis' : #numbers.formatDecimal(envio, 1, 'COMMA', 2, 'POINT')}">Precio Envio</span>
                <span class="ms-2">Estándar | 3-4 días aprox.</span>
            </div>
        </div>

        <div class="divider"></div>

        <!-- Sección de Artículos -->
        <div class="row container-fluid">

            <!-- Mostrar mensaje si NO hay productos -->
            <div class="col-12 text-center my-5" th:if="${#lists.isEmpty(detalles)}">
                <h4>Tu carrito está vacío</h4>
                <p>Agrega productos para comenzar tu compra.</p>
                <a th:href="@{'/api/home/productos/all'}" class="btn btn-primary">Seguir comprando</a>
            </div>

            <!-- Mostrar productos y resumen SOLO si hay detalles -->
            <div class="col-md-8 products-section mx-auto" th:unless="${#lists.isEmpty(detalles)}">
                <h2 class="h5 mb-3">ARTÍCULOS</h2>

                <div th:each="detalle : ${detalles}">
                    <div class="row mb-3">
                        <div class="col-8">
                            <div class="product-brand" th:text="${'Marca: ' + detalle.producto.marca}">Marca</div>
                        </div>
                        <div class="col-4 price"
                             th:text="${'Precio: ' + #numbers.formatDecimal(detalle.producto.precio, 1, 'COMMA', 2, 'POINT')}">
                            $10,99
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-8">
                            <div class="product-name" th:text="${'Nombre: ' + detalle.producto.nombre}">Nombre del producto</div>
                            <div class="product-desc" th:text="${'Descripción: ' + detalle.producto.descripcion}">Descripción</div>
                            <div class="product-quantity" th:text="'Cantidad: ' + ${detalle.cantidad}">Cantidad: 1</div>
                            <button class="btn btn-sm btn-link btn-warning eliminar-cantidad"
                                    th:attr="data-id=${detalle.producto.id}, data-cantidad=${detalle.cantidad}">
                                Eliminar Cantidad
                            </button>
                        </div>
                    </div>
                    <div class="divider"></div>
                </div>

                <!-- Resumen de compra -->
                <div class="col-md-4 summary-section">
                    <div class="row mb-2">
                        <div class="col-7 summary-label">
                            Subtotal (<span th:text="${totalItems}">0</span>)
                        </div>
                        <div class="col-5 summary-value"
                             th:text="${#numbers.formatDecimal(subtotal, 1, 'COMMA', 2, 'POINT')}">
                            $0,00
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-7 summary-label">Total de envío</div>
                        <div class="col-5 summary-value"
                             th:text="${envio == 0 ? 'Gratis' : #numbers.formatDecimal(envio, 1, 'COMMA', 2, 'POINT')}">
                            Gratis
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-7 summary-label">Impuestos</div>
                        <div class="col-5 summary-value"
                             th:text="${#numbers.formatDecimal(impuestos, 1, 'COMMA', 2, 'POINT')}">
                            $0,00
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="row mb-3">
                        <div class="col-7 total">Total</div>
                        <div class="col-5 total summary-value"
                             th:text="${#numbers.formatDecimal(total, 1, 'COMMA', 2, 'POINT')}">
                            $0,00
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-7 summary-label">Dirección de envío</div>
                    <div class="col-5 summary-value" id="direccionResumen">Sin dirección seleccionada</div>
                </div>
                <div class="row my-4">
                    <button class="btn btn-success" id="btn-pedido">
                        Realizar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="container-fluid">
    <nav class="footer-nav" role="navigation" aria-label="Navegación inferior">
        <button class="active" aria-label="Inicio">
            <a th:href="@{'/api/home/productos/all'}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M3 9.5l9-7 9 7V20a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2z" />
                </svg>
            </a>
            Inicio
        </button>
        <button aria-label="Carrito">
            <a th:href="@{'/api/home/productos/carrito'}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="9" cy="21" r="1" />
                    <circle cx="20" cy="21" r="1" />
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                </svg>
            </a>
            Carrito
        </button>
        <button aria-label="Favoritos">
            <a th:href="@{'/api/home/productos/favorites'}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                                                 class="bi bi-bag-heart-fill" viewBox="0 0 16 16">
                <path
                        d="M11.5 4v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4zM8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m0 6.993c1.664-1.711 5.825 1.283 0 5.132-5.825-3.85-1.664-6.843 0-5.132" />
            </svg>
            </a>
            Favoritos
        </button>
        <button type="button" class="btn btn-outline-danger btn-sm" id="logoutBtn" aria-label="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-door-open" viewBox="0 0 16 16">
                <path d="M8.5 10c-.276 0-.5-.448-.5-1s.224-1 .5-1 .5.448.5 1-.224 1-.5 1"/>
                <path d="M10.828.122A.5.5 0 0 1 11 .5V1h.5A1.5 1.5 0 0 1 13 2.5V15h1.5a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1H3V1.5a.5.5 0 0 1 .43-.495l7-1a.5.5 0 0 1 .398.117M11.5 2H11v13h1V2.5a.5.5 0 0 0-.5-.5M4 1.934V15h6V1.077z"/>
            </svg>
            Cerrar Sesión
        </button>
        <form id="logoutForm" th:action="@{/logout}" method="post" style="display:none;">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}" th:name="${_csrf.parameterName}">
        </form>
    </nav>
</footer>

<!-- Modal Direcciones -->
<div class="modal fade" id="modalDirecciones" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mis direcciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Lista de direcciones -->
                <ul id="listaDirecciones" class="list-group mb-3"></ul>

                <hr>
                <h6 id="tituloFormDireccion">Agregar nueva dirección</h6>
                <form id="formDireccion">
                    <input type="hidden" name="id">
                    <div class="mb-2">
                        <input type="text" name="calle" class="form-control" placeholder="Calle" required>
                    </div>
                    <div class="mb-2">
                        <input type="number" name="codigoPostal" class="form-control" placeholder="Código Postal" required>
                    </div>
                    <div class="mb-2">
                        <input type="text" name="ciudad" class="form-control" placeholder="Ciudad" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-success" id="btnGuardarDireccion">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/carrito.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      // CSRF
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

      // Recorremos todos los botones de eliminar cantidad
      document.querySelectorAll('.eliminar-cantidad').forEach(btn => {
        btn.addEventListener('click', () => {
          const idProducto = btn.dataset.id;
          const cantidadActual = parseInt(btn.dataset.cantidad, 10);

          Swal.fire({
            title: 'Eliminar cantidad',
            text: `Cantidad actual en carrito: ${cantidadActual}`,
            input: 'number',
            inputAttributes: { min: 1, max: cantidadActual, step: 1 },
            inputValue: 1,
            showCancelButton: true,
            confirmButtonText: 'Eliminar',
            cancelButtonText: 'Cancelar',
            preConfirm: (cant) => {
              if (!cant || cant < 1 || cant > cantidadActual) {
                Swal.showValidationMessage(`La cantidad debe estar entre 1 y ${cantidadActual}`);
                return false;
              }
              return cant;
            }
          }).then((result) => {
            if (result.isConfirmed) {
              fetch('/api/home/productos/carrito/eliminar', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                  productoId: idProducto,
                  cantidad: result.value
                })
              })
              .then(res => {
                if (!res.ok) throw new Error("Error al eliminar del carrito");
                return res.json();
              })
              .then(data => {
                Swal.fire('¡Actualizado!', data.message || 'Cantidad eliminada del carrito', 'success')
                  .then(() => location.reload()); // refrescar para ver cambios
              })
              .catch(err => {
                Swal.fire('Error', err.message, 'error');
              });
            }
          });
        });
      });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

      const modalDirecciones = new bootstrap.Modal(document.getElementById('modalDirecciones'));
      const listaDirecciones = document.getElementById('listaDirecciones');
      const form = document.getElementById('formDireccion');
      const tituloForm = document.getElementById('tituloFormDireccion');
      const direccionResumen = document.getElementById('direccionResumen'); // elemento en el resumen

      let direccionSeleccionada = null;

      function cargarDirecciones() {
        fetch('/api/home/productos/direcciones')
          .then(res => {
            if (!res.ok) throw new Error("Error al obtener direcciones");
            return res.json();
          })
          .then(data => {
            listaDirecciones.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
              listaDirecciones.innerHTML = '<li class="list-group-item">No tienes direcciones registradas</li>';
            } else {
              data.forEach(dir => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                  <div>
                    <strong>${dir.calle}</strong>, ${dir.ciudad} (${dir.codigoPostal})
                    ${direccionSeleccionada === dir.id ? '<span class="badge bg-success ms-2">Seleccionada</span>' : ''}
                  </div>
                  <div class="d-flex justify-content-evenly">
                    <button class="btn btn-sm btn-info me-2 btn-seleccionar" data-id="${dir.id}" data-calle="${dir.calle}" data-ciudad="${dir.ciudad}" data-cp="${dir.codigoPostal}">Usar</button>
                    <button class="btn btn-sm btn-warning me-2 btn-editar" data-id="${dir.id}">Editar</button>
                    <button class="btn btn-sm btn-danger btn-eliminar" data-id="${dir.id}">Eliminar</button>
                  </div>
                `;
                listaDirecciones.appendChild(li);
              });
            }
          })
          .catch(err => {
            console.error(err);
            listaDirecciones.innerHTML = '<li class="list-group-item text-danger">Error al cargar direcciones</li>';
          });
      }

      document.getElementById('btnVerDirecciones').addEventListener('click', () => {
        cargarDirecciones();
        form.reset();
        form.id.value = '';
        tituloForm.textContent = 'Agregar nueva dirección';
        modalDirecciones.show();
      });

      document.getElementById('btnGuardarDireccion').addEventListener('click', () => {
        const direccion = {
          calle: form.calle.value,
          codigoPostal: form.codigoPostal.value,
          ciudad: form.ciudad.value
        };
        const id = form.id.value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/home/productos/direcciones/${id}` : '/api/home/productos/direcciones';

        fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
          },
          body: JSON.stringify(direccion)
        })
        .then(res => res.json())
        .then(data => {
          Swal.fire('¡Éxito!', data.message, 'success');
          form.reset();
          form.id.value = '';
          tituloForm.textContent = 'Agregar nueva dirección';
          cargarDirecciones();
        });
      });

      listaDirecciones.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-editar')) {
          const id = e.target.dataset.id;
          fetch(`/api/home/productos/direcciones`)
            .then(res => res.json())
            .then(data => {
              const dir = data.find(d => d.id == id);
              form.id.value = dir.id;
              form.calle.value = dir.calle;
              form.codigoPostal.value = dir.codigoPostal;
              form.ciudad.value = dir.ciudad;
              tituloForm.textContent = 'Editar dirección';
            });
        }
        if (e.target.classList.contains('btn-eliminar')) {
          const id = e.target.dataset.id;
          Swal.fire({
            title: '¿Eliminar dirección?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
          }).then(result => {
            if (result.isConfirmed) {
              fetch(`/api/home/productos/direcciones/${id}`, {
                method: 'DELETE',
                headers: { [csrfHeader]: csrfToken }
              })
              .then(res => res.json())
              .then(data => {
                Swal.fire('Eliminada', data.message, 'success');
                if (direccionSeleccionada === parseInt(id)) {
                  direccionSeleccionada = null;
                  direccionResumen.textContent = 'Sin dirección seleccionada';
                }
                cargarDirecciones();
              });
            }
          });
        }
        if (e.target.classList.contains('btn-seleccionar')) {
          direccionSeleccionada = parseInt(e.target.dataset.id);
          const texto = `${e.target.dataset.calle}, ${e.target.dataset.ciudad} (${e.target.dataset.cp})`;
          direccionResumen.textContent = texto;
          Swal.fire('Dirección seleccionada', 'Se usará esta dirección para el envío', 'success');
          cargarDirecciones();
        }
      });
    });
</script>

<!-- Confirmar Pedido -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
      // 🔹 Leer CSRF desde las meta tags
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

      const btnPedido = document.getElementById("btn-pedido");

      btnPedido.addEventListener("click", () => {
        Swal.fire({
          title: "Confirmar Pedido?",
          text: "Revisa tus datos antes de confirmar!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Si, Ordenar!",
          cancelButtonText: "No, Cancelar..."
        }).then((result) => {
          if (result.isConfirmed) {
            fetch('/api/home/productos/pedido', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
              }
            })
            .then(res => res.json())
            .then(data => {
              if (data.error) {
                Swal.fire('Error', data.error, 'error');
              } else {
                Swal.fire({
                  title: "¡Gracias!",
                  text: data.message,
                  icon: "success"
                }).then(() => {
                  location.reload(); // recargar para ver carrito vacío
                });
              }
            })
            .catch(() => {
              Swal.fire('Error', 'No se pudo procesar el pedido', 'error');
            });
          }
        });
      });
    });
</script>
</body>
</html>