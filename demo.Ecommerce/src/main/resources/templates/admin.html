<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
</head>

<body>
<div class="items-container">
    <h1 class="p-4 pb-2 text-center">Gestor de Inventario</h1>
    <hr>

    <div class="filters-btns ms-4" role="group" aria-label="Opciones de filtros">
        <button type="button" aria-label="Listado" id="btn-opciones" style="min-width: 45px; min-height: 45px;"><svg
                xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                class="bi bi-filter-left" viewBox="0 0 16 16">
            <path
                    d="M2 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5" />
        </svg></button>
    </div>
    <!-- Encabezado de la tabla (solo visible en desktop) -->
    <div class="d-none d-md-grid table-header" style="grid-template-columns: 1fr 2fr 1fr;">
        <div class="text-center">Imagen</div>
        <div class="text-center">Detalles</div>
        <div class="text-center">Precio</div>
    </div>

    <!-- Productos Disponibles -->

    <div class="product-item text-center my-4" th:if="${#lists.isEmpty(productos_lista)}">
        No Hay Productos Disponibles
    </div>
    <div th:each="producto : ${productos_lista}" class="product-item px-3 my-3">
        <div class="row">
            <div class="col-md-3 mx-auto my-3">
                <img th:src="@{${producto.url_imagen}}" alt="Imagen del producto" style="max-with:400px;" id="img-producto" class="mx-3 my-3">
            </div>
            <div class="col-md-6 mx-auto my-3">
                <div class="my-2 ms-3 product-brand" th:text="${'Marca: ' + producto.marca}">Marca</div>
                <div class="my-2 ms-3 product-name" th:text="${'Nombre: ' + producto.nombre}">Nombre del producto</div>
                <div class="my-2 ms-3 product-desc" th:text="${'Descripcion: ' + producto.descripcion}">Descripción</div>
                <div class="my-2 ms-3 product-quantity" th:text="'Cantidad: ' + ${producto.cantidad}">Cantidad</div>
                <div class="my-2 ms-3 product-url" th:text="${'URL: ' + producto.url_imagen}" style="color: #6c757d;">Url Imagen</div>
                <div class="my-2 ms-3" th:text="${'Descuento: ' + producto.porcentajeDescuento + ' %'}">Descuento</div>
                <div class="my-2 ms-3 fw-bold" th:text="${'Categoria: ' + producto.categoria.categoria}">Nombre Categoria</div>
                <!-- Botones de acción -->
                <div class="action-buttons mt-2">

                    <!-- Botón de edición -->
                    <button type="button" class="btn  btn-sm btn-primary  ms-3 btn-editar"
                            th:data-id="${producto.id}"
                            th:data-nombre="${producto.nombre}"
                            th:data-marca="${producto.marca}"
                            th:data-descripcion="${producto.descripcion}"
                            th:data-cantidad="${producto.cantidad}"
                            th:data-precio="${producto.precio}"
                            th:data-descuento="${producto.porcentajeDescuento}"
                            th:data-imagen="${producto.url_imagen}"
                            th:data-categoria="${producto.categoria.id}">
                        Editar
                    </button>

                    <!-- Boton de eliminacion -->
                    <button class="btn btn-sm btn-danger ms-4 btn-eliminar" th:attr="data-url=@{/api/admin/delete/{id}(id=${producto.id})}">
                        Eliminar
                    </button>
                </div>
            </div>
            <div class="col-md-3 mx-auto my-3">
                <div th:text="'$' + ${producto.precio}" class="price ">Precio</div>
            </div>
        </div>
    </div>
    <hr>
    <div class="d-flex justify-content-evenly mb-5">
        <button class="btn btn-link" data-bs-target="#modal-nuevo-producto" data-bs-toggle="modal">
            Nuevo Producto +
        </button>
        <button class="btn btn-link" data-bs-target="#modal-nueva-categoria" data-bs-toggle="modal">
            Nueva Categoría +
        </button>
    </div>
</div>

<footer class="container-fluid">
    <nav class="footer-nav" role="navigation" aria-label="Navegación inferior">
        <button class="active" aria-label="Inicio">
            <a th:href="@{/api/admin/index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="26" fill="currentColor"
                     class="bi bi-database-check" viewBox="0 0 16 16">
                    <path
                            d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m1.679-4.493-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548 1.17-1.951a.5.5 0 1 1 .858.514" />
                    <path
                            d="M12.096 6.223A5 5 0 0 0 13 5.698V7c0 .289-.213.654-.753 1.007a4.5 4.5 0 0 1 1.753.25V4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16c.536 0 1.058-.034 1.555-.097a4.5 4.5 0 0 1-.813-.927Q8.378 15 8 15c-1.464 0-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13h.027a4.6 4.6 0 0 1 0-1H8c-1.464 0-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10q.393 0 .774-.024a4.5 4.5 0 0 1 1.102-1.132C9.298 8.944 8.666 9 8 9c-1.464 0-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777M3 4c0-.374.356-.875 1.318-1.313C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4" />
                </svg>
            </a>
            Gestor Inventario
        </button>

        <button aria-label="Cuentas">
            <a href="usuarios.html"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="26"
                                         fill="currentColor" class="bi bi-people" viewBox="0 0 16 16">
                <path
                        d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1zm-7.978-1L7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002-.014.002zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0M6.936 9.28a6 6 0 0 0-1.23-.247A7 7 0 0 0 5 9c-4 0-5 3-5 4q0 1 1 1h4.216A2.24 2.24 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816M4.92 10A5.5 5.5 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0m3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4" />
            </svg>
            </a>
            Gestionar Cuentas
        </button>
        <button aria-label="pedidos">
            <a href="pedidos.html">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor"
                     class="bi bi-receipt-cutoff" viewBox="0 0 16 16">
                    <path
                            d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5M11.5 4a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1z" />
                    <path
                            d="M2.354.646a.5.5 0 0 0-.801.13l-.5 1A.5.5 0 0 0 1 2v13H.5a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1H15V2a.5.5 0 0 0-.053-.224l-.5-1a.5.5 0 0 0-.8-.13L13 1.293l-.646-.647a.5.5 0 0 0-.708 0L11 1.293l-.646-.647a.5.5 0 0 0-.708 0L9 1.293 8.354.646a.5.5 0 0 0-.708 0L7 1.293 6.354.646a.5.5 0 0 0-.708 0L5 1.293 4.354.646a.5.5 0 0 0-.708 0L3 1.293zm-.217 1.198.51.51a.5.5 0 0 0 .707 0L4 1.707l.646.647a.5.5 0 0 0 .708 0L6 1.707l.646.647a.5.5 0 0 0 .708 0L8 1.707l.646.647a.5.5 0 0 0 .708 0L10 1.707l.646.647a.5.5 0 0 0 .708 0L12 1.707l.646.647a.5.5 0 0 0 .708 0l.509-.51.137.274V15H2V2.118z" />
                </svg>
            </a>
            Gestionar Pedidos
        </button>
        <button aria-label="Perfil">
            <a href="login.html"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"
                                      aria-hidden="true">
                <circle cx="12" cy="7" r="4" />
                <path d="M5.5 21a6.5 6.5 0 0 1 13 0" />
            </svg>
            </a>
            Perfil
        </button>
    </nav>
</footer>


<!-- Modal para Crear Nuevo Producto -->
<div id="modal-nuevo-producto" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Nuevo Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form th:action="@{/api/admin/save}" th:object="${productoDTO}" method="post">
                <input type="hidden" th:field="*{id}" />

                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row gx-2">

                            <!-- Nombre -->
                            <div class="col-md-6 mb-3">
                                <label for="nombre" class="form-label">Nombre</label>
                                <input type="text" th:field="*{nombre}" class="form-control" id="nombre"
                                       placeholder="Nombre del producto" required>
                            </div>

                            <!-- Marca -->
                            <div class="col-md-6 mb-3">
                                <label for="marca" class="form-label">Marca</label>
                                <input type="text" th:field="*{marca}" class="form-control" id="marca"
                                       placeholder="Marca" required>
                            </div>

                            <!-- Descripción -->
                            <div class="col-12 mb-3">
                                <label for="descripcion" class="form-label">Descripción</label>
                                <textarea th:field="*{descripcion}" class="form-control" id="descripcion" rows="3"
                                          placeholder="Descripción" required></textarea>
                            </div>

                            <!-- Cantidad -->
                            <div class="col-md-6 mb-3">
                                <label for="cantidad" class="form-label">Cantidad</label>
                                <input type="number" th:field="*{cantidad}" class="form-control" id="cantidad"
                                       min="0" placeholder="0" required>
                            </div>

                            <!-- Precio -->
                            <div class="col-md-6 mb-3">
                                <label for="precio" class="form-label">Precio</label>
                                <input type="number" th:field="*{precio}" step="0.01" class="form-control"
                                       id="precio" placeholder="0.00" required>
                            </div>

                            <!-- Descuento (opcional) -->
                            <div class="col-md-6 mb-3">
                                <label for="porcentajeDescuento" class="form-label">Descuento (%)</label>
                                <input type="number" th:field="*{porcentajeDescuento}" class="form-control"
                                       id="porcentajeDescuento" min="0" max="100" placeholder="Opcional">
                            </div>

                            <!-- URL de Imagen -->
                            <div class="col-md-6 mb-3">
                                <label for="url_imagen" class="form-label">URL de Imagen</label>
                                <input type="url" th:field="*{url_imagen}" class="form-control" id="url_imagen"
                                       placeholder="https://..." required>
                            </div>

                            <!-- Select de Categorías -->
                            <div class="col-12 mb-3">
                                <label for="categoria" class="form-label">Categoría</label>
                                <select th:field="*{categoria.id}" class="form-select" id="categoria" required>
                                    <option value="" disabled selected>Selecciona una categoría</option>
                                    <option th:each="cat : ${categorias_lista}" th:value="${cat.id}" th:text="${cat.categoria}"></option>
                                </select>
                            </div>


                        </div>
                    </div>
                </div>

                <div class="modal-footer d-flex justify-content-evenly">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                    <button type="submit" class="btn btn-success">
                        Agregar +
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>



<!-- Modal nueva Categoria -->
<div id="modal-nueva-categoria" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Nueva Categoría</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar">
                </button>
            </div>

            <form th:action="@{/api/admin/category/save}" th:object="${categoriaDTO}" method="post">
                <input type="hidden" th:field="*{id}" />
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row gx-2">

                            <!-- Nombre de la categoría -->
                            <div class="col-12 mb-3">
                                <label for="categoriaTxt" class="form-label">Categoría</label>
                                <input type="text" th:field="*{categoria}" class="form-control" id="categoriaTxt" required
                                       placeholder="Nombre de la categoría">
                            </div>

                            <!-- Descripción -->
                            <div class="col-12 mb-3">
                                <label for="descripcionTxt" class="form-label">Descripción</label>
                                <textarea th:field="*{descripcion}" class="form-control" id="descripcionTxt" rows="3" required
                                          placeholder="Descripción de la categoría"></textarea>
                            </div>

                            <!-- URL de la imagen -->
                            <div class="col-12 mb-3">
                                <label for="urlImagen" class="form-label">URL de Imagen</label>
                                <input type="url" th:field="*{url_imagen}" class="form-control" id="urlImagen" required
                                       placeholder="https://...">
                            </div>

                        </div>
                    </div>
                </div>

                <div class="modal-footer justify-content-evenly">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                    <button type="submit" class="btn btn-success">
                        Agregar
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- Modal de edición único -->
<!-- Modal de edición -->
<div class="modal fade" id="modal-editar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="form-editar" th:object="${productoDTO}" data-action-template="/api/admin/edit/{id}" method="post">
                <input type="hidden" id="edit-id" th:field="*{id}" />

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalEditarLabel">Editar Producto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger" role="alert">
                        <div th:each="err : ${#fields.globalErrors()}" th:text="${err}"></div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="edit-nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" th:field="*{nombre}" class="form-control" id="edit-nombre"
                                   th:classappend="${#fields.hasErrors('nombre')} ? 'is-invalid' : ''" required />
                            <div th:if="${#fields.hasErrors('nombre')}" class="invalid-feedback">
                                <span th:errors="*{nombre}"></span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="edit-marca" class="form-label">Marca <span class="text-danger">*</span></label>
                            <input type="text" th:field="*{marca}" class="form-control" id="edit-marca"
                                   th:classappend="${#fields.hasErrors('marca')} ? 'is-invalid' : ''" required />
                            <div th:if="${#fields.hasErrors('marca')}" class="invalid-feedback">
                                <span th:errors="*{marca}"></span>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="edit-descripcion" class="form-label">Descripción <span class="text-danger">*</span></label>
                            <textarea th:field="*{descripcion}" class="form-control" id="edit-descripcion" rows="3"
                                      th:classappend="${#fields.hasErrors('descripcion')} ? 'is-invalid' : ''" required></textarea>
                            <div th:if="${#fields.hasErrors('descripcion')}" class="invalid-feedback">
                                <span th:errors="*{descripcion}"></span>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="edit-cantidad" class="form-label">Cantidad <span class="text-danger">*</span></label>
                            <input type="number" th:field="*{cantidad}" class="form-control" id="edit-cantidad"
                                   th:classappend="${#fields.hasErrors('cantidad')} ? 'is-invalid' : ''" min="0" required />
                            <div th:if="${#fields.hasErrors('cantidad')}" class="invalid-feedback">
                                <span th:errors="*{cantidad}"></span>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="edit-precio" class="form-label">Precio <span class="text-danger">*</span></label>
                            <input type="number" th:field="*{precio}" class="form-control" id="edit-precio"
                                   th:classappend="${#fields.hasErrors('precio')} ? 'is-invalid' : ''" min="0" required />
                            <div th:if="${#fields.hasErrors('precio')}" class="invalid-feedback">
                                <span th:errors="*{precio}"></span>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="edit-descuento" class="form-label">Descuento (%)</label>
                            <input type="number"  th:field="*{porcentajeDescuento}" class="form-control" id="edit-descuento"
                                   th:classappend="${#fields.hasErrors('porcentajeDescuento')} ? 'is-invalid' : ''" min="0" max="30" />
                            <div th:if="${#fields.hasErrors('porcentajeDescuento')}" class="invalid-feedback">
                                <span th:errors="*{porcentajeDescuento}"></span>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="edit-imagen" class="form-label">URL Imagen <span class="text-danger">*</span></label>
                            <input type="text" th:field="*{url_imagen}" class="form-control" id="edit-imagen"
                                   th:classappend="${#fields.hasErrors('url_imagen')} ? 'is-invalid' : ''" required />
                            <div th:if="${#fields.hasErrors('url_imagen')}" class="invalid-feedback">
                                <span th:errors="*{url_imagen}"></span>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="edit-categoria" class="form-label">Categoría <span class="text-danger">*</span></label>
                            <select th:field="*{categoria.id}" class="form-select" id="edit-categoria"
                                    th:classappend="${#fields.hasErrors('categoria.id')} ? 'is-invalid' : ''" required>
                                <option value="">Seleccione una categoría</option>
                                <option th:each="cat : ${categorias_lista}"
                                        th:value="${cat.id}"
                                        th:text="${cat.categoria}"
                                        th:selected="${cat.id == productoDTO.categoria.id}">
                                </option>
                            </select>
                            <div th:if="${#fields.hasErrors('categoria.id')}" class="invalid-feedback">
                                <span th:errors="*{categoria.id}"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/admin.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', ()=> {
      const modalEl   = document.getElementById('modal-editar');
      const modal     = new bootstrap.Modal(modalEl);
      const formEditar= document.getElementById('form-editar');
      const template  = formEditar.dataset.actionTemplate; // "/api/admin/edit/{id}"

      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', ()=> {
          // Poblar campos
          document.getElementById('edit-id').value          = btn.dataset.id;
          document.getElementById('edit-nombre').value      = btn.dataset.nombre;
          document.getElementById('edit-marca').value       = btn.dataset.marca;
          document.getElementById('edit-descripcion').value = btn.dataset.descripcion;
          document.getElementById('edit-cantidad').value    = btn.dataset.cantidad;
          document.getElementById('edit-precio').value      = btn.dataset.precio;
          document.getElementById('edit-descuento').value   = btn.dataset.descuento;
          document.getElementById('edit-imagen').value      = btn.dataset.imagen;
          document.getElementById('edit-categoria').value   = btn.dataset.categoria;

          // Actualizar URL de envío
          formEditar.setAttribute(
            'action',
            template.replace('{id}', btn.dataset.id)
          );

          // Mostrar modal
          modal.show();
        });
      });
    });
</script>

</body>

</html>